import sys
from google.protobuf import descriptor_pb2
import os

def generate_proxy(service_name, service_proto, output_path, channel_addr):
    '''
    Builds a proxy file given a service name, and writes it to the
    given output path.
    '''
    root = os.getenv('ROOTPATH')
    if not root:
        root = '../'
    fds = descriptor_pb2.FileDescriptorSet()
    with open(f'{root}protocol/protocol.desc', "rb") as f:
        fds.MergeFromString(f.read())
    with open(output_path, 'w') as f:
        # Write out auto-generated lines
        lines = []
        lines.append("############################################################")
        lines.append("# NOTE: THIS FILE IS AUTOGENERATED BY PROXY.PY. DO NOT EDIT!")
        lines.append("############################################################")
        lines.append("import grpc")
        lines.append("")
        lines.append("# Import generated code from your compiled protos")
        lines.append(f"import bindings.python.services.{service_proto}_pb2 as {service_proto}_pb2")
        lines.append(f"import bindings.python.services.{service_proto}_pb2_grpc as {service_proto}_pb2_grpc")
        lines.append("")
        lines.append(f"class {service_name}Proxy({service_proto}_pb2_grpc.{service_name}Servicer):")
        lines.append("    def __init__(self):")
        lines.append(f"        self._channel = grpc.aio.insecure_channel('{channel_addr}')")
        lines.append(f"        self._stub = {service_proto}_pb2_grpc.{service_name}Stub(self._channel)")
        
        # Iterate through the descriptor set until target service is found
        for file in fds.file:
            if file.name != f'services/{service_proto}.proto':
                continue
            for service in file.service:
                if service.name != service_name:
                    continue
                # Generate proxy methods for each of the methods in the service
                for method in service.method:
                    rpc_name = method.name
                    if method.client_streaming and method.server_streaming:
                        raise NotImplemented("No proxy generation method for method type: bidirectional stream!")
                    elif method.client_streaming:
                        raise NotImplemented("No proxy generation method for method type: client stream!")
                    elif method.server_streaming:
                        lines.append(f"    async def {rpc_name}(self, request, context):")
                        lines.append(f"        async for resp in self._stub.{rpc_name}(request):")
                        lines.append(f"            yield resp")
                    else:
                        lines.append(f"    async def {rpc_name}(self, request, context):")
                        lines.append(f"        return await self._stub.{rpc_name}(request)")
        
        f.writelines("\n".join(lines))
